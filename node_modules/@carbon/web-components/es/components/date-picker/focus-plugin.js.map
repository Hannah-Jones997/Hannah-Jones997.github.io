{"version":3,"file":"focus-plugin.js","sources":["../../../src/components/date-picker/focus-plugin.ts"],"sourcesContent":["/**\n * Copyright IBM Corp. 2019, 2025\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { Instance as FlatpickrInstance } from 'flatpickr/dist/types/instance';\nimport { Plugin } from 'flatpickr/dist/types/options';\nimport on from '../../globals/mixins/on';\nimport Handle from '../../globals/internal/handle';\nimport CDSDatePickerInput from './date-picker-input';\n\n/**\n * The configuration for the Flatpickr plugin to set CSS classes specific to this design system.\n */\nexport interface DatePickerFocusPluginConfig {\n  /**\n   * The input box to enter starting date.\n   */\n  inputFrom: CDSDatePickerInput;\n\n  /**\n   * The input box to enter end date.\n   */\n  inputTo?: CDSDatePickerInput;\n}\n\n/**\n * `FlatpickrInstance` with additional properties used for `carbonFlatpickrFocusPlugin`.\n */\nexport interface ExtendedFlatpickrInstanceFocusPlugin\n  extends FlatpickrInstance {\n  /**\n   * The handle for `blur` event handler in calendar dropdown.\n   */\n  _hCDSCEDatePickerFocusPluginBlur?: Handle | null;\n\n  /**\n   * The handle for `keydown` event handler in the `<input>` for the starting date.\n   */\n  _hCDSCEDatePickerFocusPluginKeydownFrom?: Handle | null;\n\n  /**\n   * The handle for `keydown` event handler in the `<input>` for the end date.\n   */\n  _hCDSCEDatePickerFocusPluginKeydownTo?: Handle | null;\n\n  /**\n   * The handle for `focus` event handler in the `<input>` for the starting date.\n   */\n  _hCDSCEDatePickerFocusPluginFocusFrom?: Handle | null;\n\n  /**\n   * The handle for `focus` event handler in the `<input>` for the end date.\n   */\n  _hCDSCEDatePickerFocusPluginFocusTo?: Handle | null;\n\n  /**\n   * Lastly focused `<input>` for starting/end date.\n   */\n  _lastFocusInput?: CDSDatePickerInput;\n}\n\n/**\n * @param config Plugin configuration.\n * @returns A Flatpickr plugin to manage focus to align with the UX pattern in our design system.\n */\nexport default (config: DatePickerFocusPluginConfig): Plugin =>\n  (fp: ExtendedFlatpickrInstanceFocusPlugin) => {\n    /**\n     * Focuses on calendar dropdown.\n     */\n    const focusCalendar = () => {\n      const { calendarContainer, selectedDateElem, todayDateElem } = fp;\n      (selectedDateElem || todayDateElem || calendarContainer).focus();\n    };\n\n    /**\n     * Handles `keydown` event for date picker input field\n     */\n    const handleInputKeydown = (event: KeyboardEvent) => {\n      if (!(event.target instanceof CDSDatePickerInput)) return;\n\n      const { key } = event;\n\n      if (key === 'Escape') {\n        fp.close();\n      }\n      if (key === 'Tab') {\n        if (!event.shiftKey) {\n          event.preventDefault();\n          fp.open();\n          focusCalendar();\n        } else if (fp.isOpen && event.target === config.inputFrom) {\n          fp.close();\n        }\n      }\n    };\n\n    /**\n     * Handles `keydown` event for calendar dropdown\n     */\n    const handleCalendarKeydown = (event: KeyboardEvent) => {\n      const endInput = config.inputTo ? config.inputTo : config.inputFrom;\n      const { key } = event;\n\n      if (key === 'Tab') {\n        if (!event.shiftKey) {\n          if (fp._lastFocusInput === endInput) {\n            endInput.focus();\n            fp.close();\n          } else {\n            event.preventDefault();\n            endInput.focus();\n          }\n        } else if (fp._lastFocusInput === endInput) {\n          event.preventDefault();\n          setTimeout(() => endInput.focus(), 0);\n        }\n      }\n    };\n\n    /**\n     * Handles `focus` event on `<input>` for starting/end date to track the lastly focused one.\n     */\n    const handleInputFocus = ({ target }: FocusEvent) => {\n      fp._lastFocusInput = target as CDSDatePickerInput;\n    };\n\n    /**\n     * Releases event listeners used in this Flatpickr plugin.\n     */\n    const release = () => {\n      if (fp._hCDSCEDatePickerFocusPluginBlur) {\n        fp._hCDSCEDatePickerFocusPluginBlur =\n          fp._hCDSCEDatePickerFocusPluginBlur.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginFocusTo) {\n        fp._hCDSCEDatePickerFocusPluginFocusTo =\n          fp._hCDSCEDatePickerFocusPluginFocusTo.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginFocusFrom) {\n        fp._hCDSCEDatePickerFocusPluginFocusFrom =\n          fp._hCDSCEDatePickerFocusPluginFocusFrom.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginKeydownTo) {\n        fp._hCDSCEDatePickerFocusPluginKeydownTo =\n          fp._hCDSCEDatePickerFocusPluginKeydownTo.release();\n      }\n      if (fp._hCDSCEDatePickerFocusPluginKeydownFrom) {\n        fp._hCDSCEDatePickerFocusPluginKeydownFrom =\n          fp._hCDSCEDatePickerFocusPluginKeydownFrom.release();\n      }\n    };\n\n    /**\n     * Sets up event listeners used for this Flatpickr plugin.\n     */\n    const init = () => {\n      release();\n      const { inputFrom, inputTo } = config;\n      fp._hCDSCEDatePickerFocusPluginBlur = on(\n        fp.calendarContainer,\n        'keydown',\n        handleCalendarKeydown,\n        true\n      );\n      fp._hCDSCEDatePickerFocusPluginKeydownFrom = on(\n        inputFrom,\n        'keydown',\n        handleInputKeydown\n      );\n      if (inputTo) {\n        fp._hCDSCEDatePickerFocusPluginKeydownTo = on(\n          inputTo,\n          'keydown',\n          handleInputKeydown\n        );\n      }\n      fp._hCDSCEDatePickerFocusPluginFocusFrom = on(\n        inputFrom,\n        'focus',\n        handleInputFocus\n      );\n      if (inputTo) {\n        fp._hCDSCEDatePickerFocusPluginFocusTo = on(\n          inputTo,\n          'focus',\n          handleInputFocus\n        );\n      }\n    };\n\n    /**\n     * Registers this Flatpickr plugin.\n     *\n     */\n    const register = () => {\n      fp.loadedPlugins.push('carbonFlatpickrFocusPlugin');\n    };\n\n    return {\n      onReady: [register, init],\n      onDestroy: release,\n    };\n  };\n"],"names":[],"mappings":"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"}