{"version":3,"file":"floating-menu.js","sources":["../../../src/components/floating-menu/floating-menu.ts"],"sourcesContent":["/**\n * Copyright IBM Corp. 2019, 2024\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { LitElement } from 'lit';\nimport HostListener from '../../globals/decorators/host-listener';\nimport FocusMixin from '../../globals/mixins/focus';\nimport HostListenerMixin from '../../globals/mixins/host-listener';\nimport Handle from '../../globals/internal/handle';\nimport {\n  FLOATING_MENU_DIRECTION,\n  FLOATING_MENU_POSITION_DIRECTION,\n} from './defs';\nimport CDSFloatingMenuTrigger from './floating-menu-trigger';\nimport { prefix } from '../../globals/settings';\n\nexport { FLOATING_MENU_DIRECTION, FLOATING_MENU_POSITION_DIRECTION };\n\n/**\n * Position of floating menu, or trigger button of floating menu.\n */\nexport interface FloatingMenuPosition {\n  /**\n   * The LTR/RTL direction used for positioning floating menu.\n   */\n  direction: FLOATING_MENU_POSITION_DIRECTION;\n\n  /**\n   * The start position (Left position for LTR, right position for RTL).\n   */\n  start: number;\n\n  /**\n   * The top position.\n   */\n  top: number;\n}\n\n/**\n * Observes resize of the given element with the given resize observer.\n *\n * @param observer The resize observer.\n * @param elem The element to observe the resize.\n */\nconst observeResize = (observer: ResizeObserver, elem: Element) => {\n  observer.observe(elem);\n  return {\n    release() {\n      observer.unobserve(elem);\n      return null;\n    },\n  } as Handle;\n};\n\n/**\n * @param elem The starting element.\n * @param selector The CSS selector.\n * @returns {Element}\n *   The closest ancestor node of the given element that matches the given selector, crossing Shadow DOM boundary.\n */\nconst closestComposed = (elem: Element, selector: string) => {\n  const found = elem.closest(selector);\n  if (found) {\n    return found;\n  }\n  const { host } = elem.getRootNode() as ShadowRoot;\n  if (host) {\n    return closestComposed(host, selector);\n  }\n  return null;\n};\n\n/**\n * Floating menu.\n */\nabstract class CDSFloatingMenu extends HostListenerMixin(\n  FocusMixin(LitElement)\n) {\n  /**\n   * The handle for observing resize of the element containing the trigger button.\n   */\n  private _hObserveResizeParent: Handle | null = null;\n\n  /**\n   * The handle for observing resize of the floating menu container.\n   */\n  private _hObserveResizeContainer: Handle | null = null;\n\n  /**\n   * The `ResizeObserver` instance for observing element resizes for re-positioning floating menu position.\n   */\n  // TODO: Wait for `.d.ts` update to support `ResizeObserver`\n  // @ts-ignore\n  private _resizeObserver = new ResizeObserver(() => {\n    const { container, open, parent, position } = this;\n    if (container && open && parent) {\n      const { direction, start, top } = position;\n      this.style[\n        direction !== FLOATING_MENU_POSITION_DIRECTION.RTL ? 'left' : 'right'\n      ] = `${start}px`;\n      this.style.top = `${top}px`;\n    }\n  });\n\n  @HostListener('focusout')\n  // @ts-ignore: The decorator refers to this method but TS thinks this method is not referred to\n  private _handleBlur = ({ relatedTarget }: FocusEvent) => {\n    if (!this.contains(relatedTarget as Node)) {\n      const { parent } = this;\n      if (parent && parent !== relatedTarget) {\n        parent.open = false;\n        HTMLElement.prototype.focus.call(this.parent); // SVGElement in IE11 does not have `.focus()` method\n      }\n    }\n  };\n\n  @HostListener('click')\n  // @ts-ignore: The decorator refers to this method but TS thinks this method is not referred to\n  private _click = () => {\n    const { parent } = this;\n    if (parent) {\n      parent.open = false;\n    }\n  };\n\n  @HostListener('keydown')\n  // @ts-ignore: The decorator refers to this method but TS thinks this method is not referred to\n  private _handleKeyDown = (event: KeyboardEvent) => {\n    if (event.key === 'Tab') {\n      if (event.shiftKey) {\n        const { parent } = this;\n        if (parent) {\n          parent.open = false;\n        }\n      }\n    }\n  };\n\n  /**\n   * The DOM element, typically a custom element in this library, launching this floating menu.\n   */\n  protected parent: CDSFloatingMenuTrigger | null = null;\n\n  /**\n   * The menu direction.\n   */\n  abstract direction: FLOATING_MENU_DIRECTION;\n\n  /**\n   * `true` if the menu should be open.\n   */\n  abstract open: boolean;\n\n  /**\n   * `true` if the menu alignment should be flipped.\n   */\n  abstract flipped: boolean;\n\n  /**\n   * The DOM element to put this menu into.\n   */\n  get container() {\n    return (\n      closestComposed(\n        this,\n        (this.constructor as typeof CDSFloatingMenu).selectorContainer\n      ) || this.ownerDocument!.body\n    );\n  }\n\n  /**\n   * The position of this floating menu.\n   */\n  get position(): FloatingMenuPosition {\n    const { triggerPosition } = this.parent!;\n    if (!triggerPosition) {\n      throw new TypeError('Missing information of trigger button position.');\n    }\n\n    const { container } = this;\n    const {\n      left: refLeft = 0,\n      top: refTop = 0,\n      right: refRight = 0,\n    } = triggerPosition;\n    let { bottom: refBottom = 0 } = triggerPosition;\n    const { width, height } = this.getBoundingClientRect();\n    const {\n      left: containerLeft = 0,\n      right: containerRight = 0,\n      top: containerTop = 0,\n    } = container.getBoundingClientRect();\n    refBottom = refBottom - containerTop;\n\n    const containerComputedStyle =\n      container.ownerDocument!.defaultView!.getComputedStyle(container);\n    const positionDirection = containerComputedStyle.getPropertyValue(\n      'direction'\n    ) as FLOATING_MENU_POSITION_DIRECTION;\n    const isRtl = positionDirection === FLOATING_MENU_POSITION_DIRECTION.RTL;\n    const containerStartFromViewport = !isRtl\n      ? containerLeft\n      : container.ownerDocument!.defaultView!.innerWidth - containerRight;\n    const refStartFromContainer = !isRtl\n      ? refLeft - containerLeft\n      : containerRight - refRight;\n    const refEndFromContainer = !isRtl\n      ? refRight - containerLeft\n      : containerRight - refLeft;\n    const refTopFromContainer = refTop - containerTop;\n\n    if (\n      (container !== this.ownerDocument!.body ||\n        containerStartFromViewport !== 0 ||\n        containerTop !== 0) &&\n      containerComputedStyle.getPropertyValue('position') === 'static'\n    ) {\n      throw new Error(\n        'Floating menu container must not have `position:static`.'\n      );\n    }\n\n    const { flipped, direction } = this;\n    if (Object.values(FLOATING_MENU_DIRECTION).indexOf(direction) < 0) {\n      throw new Error(`Wrong menu position direction: ${direction}`);\n    }\n\n    const alignmentStart = flipped\n      ? refEndFromContainer - width\n      : refStartFromContainer;\n\n    const { start, top } = {\n      [FLOATING_MENU_DIRECTION.TOP]: () => ({\n        start: alignmentStart,\n        top: refTopFromContainer - height,\n      }),\n      [FLOATING_MENU_DIRECTION.BOTTOM]: () => ({\n        start: alignmentStart,\n        top: refBottom,\n      }),\n    }[direction]();\n\n    return {\n      direction: positionDirection,\n      start,\n      top,\n    };\n  }\n\n  disconnectedCallback() {\n    if (this._hObserveResizeContainer) {\n      this._hObserveResizeContainer = this._hObserveResizeContainer.release();\n    }\n    if (this._hObserveResizeParent) {\n      this._hObserveResizeParent = this._hObserveResizeParent.release();\n    }\n  }\n\n  updated(changedProperties) {\n    const { container, open, parent } = this;\n    if (\n      (changedProperties.has('flipped') ||\n        changedProperties.has('direction') ||\n        changedProperties.has('open')) &&\n      open\n    ) {\n      if (!parent) {\n        this.parent = this.parentElement as CDSFloatingMenuTrigger;\n        container.appendChild(this);\n      }\n      // Note: `this.position` cannot be referenced until `this.parent` is set\n      const { direction, start, top } = this.position;\n      this.style[\n        direction !== FLOATING_MENU_POSITION_DIRECTION.RTL ? 'left' : 'right'\n      ] = `${start}px`;\n      this.style.top = `${top}px`;\n    }\n    if (changedProperties.has('open')) {\n      if (this._hObserveResizeContainer) {\n        this._hObserveResizeContainer = this._hObserveResizeContainer.release();\n      }\n      if (this._hObserveResizeParent) {\n        this._hObserveResizeParent = this._hObserveResizeParent.release();\n      }\n      if (open) {\n        const { parentElement } = this.parent ?? {};\n        this._hObserveResizeContainer = observeResize(\n          this._resizeObserver,\n          container\n        );\n        if (parentElement) {\n          this._hObserveResizeParent = observeResize(\n            this._resizeObserver,\n            parentElement\n          );\n        }\n      }\n    }\n  }\n\n  /**\n   * A constant indicating that this class is a floating menu.\n   */\n  static FLOATING_MENU = true;\n\n  /**\n   * The CSS selector to find the element to put this floating menu in.\n   */\n  static get selectorContainer() {\n    return `[data-floating-menu-container],${prefix}-modal`;\n  }\n  static shadowRootOptions = {\n    ...LitElement.shadowRootOptions,\n    delegatesFocus: true,\n  };\n}\n\nexport default CDSFloatingMenu;\n"],"names":[],"mappings":"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"}