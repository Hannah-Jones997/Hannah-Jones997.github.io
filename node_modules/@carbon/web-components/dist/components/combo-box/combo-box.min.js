/**
 * Copyright IBM Corp. 2019, 2020
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
/**
 * @license
 * 
 * This bundle contains the following third-party dependencies:
 * 
 * Also refer to the following links for the license of other third-party dependencies:
 * 
 * https://www.npmjs.com/package/tslib
 * https://www.npmjs.com/package/lit
 * https://www.npmjs.com/package/@lit/context
 * https://www.npmjs.com/package/lodash-es
 * https://www.npmjs.com/package/@floating-ui/dom
 * https://www.npmjs.com/package/flatpickr
 * https://www.npmjs.com/package/lit-html
 * https://www.npmjs.com/package/lit-element
 * https://www.npmjs.com/package/@lit/reactive-element
 * https://www.npmjs.com/package/@floating-ui/core
 * https://www.npmjs.com/package/@floating-ui/utils
 */

import{__decorate as e}from"../../node_modules/tslib/tslib.es6.min.js";import{classMap as t}from"../../node_modules/lit-html/directives/class-map.min.js";import"../../node_modules/@lit/reactive-element/reactive-element.min.js";import{html as i}from"../../node_modules/lit-html/lit-html.min.js";import"../../node_modules/lit-element/lit-element.min.js";import{property as o}from"../../node_modules/@lit/reactive-element/decorators/property.min.js";import{query as l}from"../../node_modules/@lit/reactive-element/decorators/query.min.js";import s from"../../packages/icons/lib/close/16.min.js";import{prefix as n}from"../../globals/settings.min.js";import{findIndex as r,forEach as a}from"../../globals/internal/collection-helpers.min.js";import d from"../dropdown/dropdown.min.js";import u from"./combo-box.scss.min.js";import{carbonElement as c}from"../../globals/decorators/carbon-element.min.js";import{ifDefined as m}from"../../node_modules/lit-html/directives/if-defined.min.js";import h from"../../globals/directives/if-non-empty.min.js";import{DROPDOWN_KEYBOARD_ACTION as p}from"../dropdown/defs.min.js";export{DROPDOWN_DIRECTION,DROPDOWN_SIZE}from"../dropdown/defs.min.js";let b=class extends d{constructor(){super(...arguments),this._filterInputValue="",this._shouldTriggerBeFocusable=!1,this.clearSelectionLabel="Clear selection",this.inputLabel=""}_testItemWithQueryText(e){return(this.itemMatches||this._defaultItemMatches)(e,this._filterInputNode.value)}_defaultItemMatches(e,t){return e.textContent.toLowerCase().indexOf(t.toLowerCase())>=0}_handleInput(){0!=this._filterInputValue.length?this.setAttribute("isClosable",""):this.removeAttribute("isClosable");const e=this.querySelectorAll(this.constructor.selectorItem),t=this._filterInputNode.value?r(e,this._testItemWithQueryText,this):-1;a(e,((e,i)=>{var o;if(i===t){const t=null===(o=this._itemMenu)||void 0===o?void 0:o.getBoundingClientRect(),i=e.getBoundingClientRect();if(t&&i){if(!(t.top<=(null==i?void 0:i.top)&&(null==i?void 0:i.bottom)<=(null==t?void 0:t.top)+this._itemMenu.clientHeight)){const e=(null==i?void 0:i.top)-(null==t?void 0:t.top),o=(null==i?void 0:i.bottom)-(null==t?void 0:t.bottom);Math.abs(e)<Math.abs(o)?this._itemMenu.scrollTop+=e:this._itemMenu.scrollTop+=o}}}e.highlighted=i===t}));const{_filterInputNode:i}=this;this._filterInputValue=i?i.value:"",this.open=!0,this.requestUpdate()}_handleClickInner(e){var t;const{target:i}=e;(null===(t=this._selectionButtonNode)||void 0===t?void 0:t.contains(i))?this._handleUserInitiatedClearInput():super._handleClickInner(e)}_handleKeypressInner(e){var t;const{key:i}=e,o=this.constructor.getAction(i),{TRIGGERING:l}=p;!(null===(t=this._selectionButtonNode)||void 0===t?void 0:t.contains(e.target))||o!==l&&" "!==i?super._handleKeypressInner(e):this._handleUserInitiatedClearInput()}_handleUserInitiatedClearInput(){a(this.querySelectorAll(this.constructor.selectorItem),(e=>{e.highlighted=!1})),this._filterInputValue="",this._filterInputNode.focus(),this._handleUserInitiatedSelectItem()}_handleUserInitiatedSelectItem(e){e&&!this._selectionShouldChange(e)&&(this._filterInputValue=e.textContent||"",this.open=!1,this.requestUpdate()),super._handleUserInitiatedSelectItem(e)}_selectionDidChange(e){this.value=e?e.value:"",a(this.querySelectorAll(this.constructor.selectorItemSelected),(e=>{e.selected=!1,e.setAttribute("aria-selected","false")})),e&&(e.selected=!0,e.setAttribute("aria-selected","true")),this._handleUserInitiatedToggle(!1)}_renderLabel(){var e;const{disabled:o,inputLabel:l,label:s,open:r,readOnly:a,value:d,_activeDescendant:u,_filterInputValue:c,_handleInput:p}=this,b=t({[`${n}--text-input`]:!0,[`${n}--text-input--empty`]:!d});let _;if(r&&!u){const t=this.constructor;_=null===(e=this.querySelectorAll(t.selectorItem)[0])||void 0===e?void 0:e.id}return i`
      <input
        id="trigger-button"
        class="${b}"
        ?disabled=${o}
        placeholder="${s}"
        .value=${c}
        role="combobox"
        aria-label="${h(l)}"
        aria-controls="menu-body"
        aria-haspopup="listbox"
        aria-autocomplete="list"
        aria-expanded="${String(r)}"
        aria-activedescendant="${m(r?null!=u?u:_:"")}"
        ?readonly=${a}
        @input=${p} />
    `}_renderFollowingLabel(){const{clearSelectionLabel:e,_filterInputValue:t}=this;return 0!=t.length?this.setAttribute("isClosable",""):this.removeAttribute("isClosable"),0===t.length?void 0:i`
          <div
            id="selection-button"
            role="button"
            class="${n}--list-box__selection"
            tabindex="0"
            title="${e}">
            ${s({"aria-label":e})}
          </div>
        `}shouldUpdate(e){super.shouldUpdate(e);const{_selectedItemContent:t}=this;return t&&e.has("value")&&(this._filterInputValue=(null==t?void 0:t.textContent)||""),!0}updated(e){super.updated(e);const{_listBoxNode:t}=this;t&&t.classList.add(`${n}--combo-box`)}static get selectorItemHighlighted(){return`${n}-combo-box-item[highlighted]`}static get selectorItem(){return`${n}-combo-box-item`}static get selectorItemSelected(){return`${n}-combo-box-item[selected]`}static get eventBeforeToggle(){return`${n}-combo-box-beingtoggled`}static get eventToggle(){return`${n}-combo-box-toggled`}static get eventBeforeSelect(){return`${n}-combo-box-beingselected`}static get eventSelect(){return`${n}-combo-box-selected`}};b.TRIGGER_KEYS=new Set(["Enter"]),b.styles=u,e([l("input")],b.prototype,"_filterInputNode",void 0),e([l("#menu-body")],b.prototype,"_itemMenu",void 0),e([l("#selection-button")],b.prototype,"_selectionButtonNode",void 0),e([o({attribute:"clear-selection-label"})],b.prototype,"clearSelectionLabel",void 0),e([o({attribute:"input-label"})],b.prototype,"inputLabel",void 0),e([o({attribute:!1})],b.prototype,"itemMatches",void 0),b=e([c(`${n}-combo-box`)],b);
