/**
 * Copyright IBM Corp. 2019, 2020
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
/**
 * @license
 * 
 * This bundle contains the following third-party dependencies:
 * 
 * Also refer to the following links for the license of other third-party dependencies:
 * 
 * https://www.npmjs.com/package/tslib
 * https://www.npmjs.com/package/lit
 * https://www.npmjs.com/package/@lit/context
 * https://www.npmjs.com/package/lodash-es
 * https://www.npmjs.com/package/@floating-ui/dom
 * https://www.npmjs.com/package/flatpickr
 * https://www.npmjs.com/package/lit-html
 * https://www.npmjs.com/package/lit-element
 * https://www.npmjs.com/package/@lit/reactive-element
 * https://www.npmjs.com/package/@floating-ui/core
 * https://www.npmjs.com/package/@floating-ui/utils
 */

import{__decorate as t}from"../../node_modules/tslib/tslib.es6.min.js";import{classMap as e}from"../../node_modules/lit-html/directives/class-map.min.js";import"../../node_modules/@lit/reactive-element/reactive-element.min.js";import{html as o}from"../../node_modules/lit-html/lit-html.min.js";import{LitElement as s}from"../../node_modules/lit-element/lit-element.min.js";import{property as i}from"../../node_modules/@lit/reactive-element/decorators/property.min.js";import{query as l}from"../../node_modules/@lit/reactive-element/decorators/query.min.js";import{prefix as n,selectorTabbable as r}from"../../globals/settings.min.js";import a from"../../globals/decorators/host-listener.min.js";import c from"../../globals/mixins/host-listener.min.js";import{MODAL_SIZE as d}from"./defs.min.js";import h from"./modal.scss.min.js";import{carbonElement as u}from"../../globals/decorators/carbon-element.min.js";const m=Node.DOCUMENT_POSITION_PRECEDING|Node.DOCUMENT_POSITION_CONTAINS,p=Node.DOCUMENT_POSITION_FOLLOWING|Node.DOCUMENT_POSITION_CONTAINED_BY;function f(t,e=!1){if(e)for(let e=t.length-1;e>=0;--e){const o=t[e];if(o.focus(),o.ownerDocument.activeElement===o)return!0}else for(let e=0;e<t.length;++e){const o=t[e];if(o.focus(),o.ownerDocument.activeElement===o)return!0}return!1}let y=class extends(c(s)){constructor(){super(...arguments),this._launcher=null,this._handleClick=t=>{t.composedPath().indexOf(this.shadowRoot)<0&&!this.preventCloseOnClickOutside&&this._handleUserInitiatedClose(t.target)},this._handleBlur=async({target:t,relatedTarget:e})=>{var o;const{open:s,_startSentinelNode:i,_endSentinelNode:l}=this,r=t!==this&&this.contains(t),a=e!==this&&(this.contains(e)||(null===(o=this.shadowRoot)||void 0===o?void 0:o.contains(e))&&e!==l),{selectorTabbable:c}=this.constructor;if(s&&e&&r&&!a){const o=t.compareDocumentPosition(e);e===i||o&m?(await this.constructor._delay(),f(this.querySelectorAll(c),!0)||e===this||this.focus()):(e===l||o&p)&&(await this.constructor._delay(),f(this.querySelectorAll(c))||this.focus())}const d=document.querySelector(`${n}-modal`),h=document.querySelector(`${n}-modal-body`);if(!(d&&d.hasAttribute("has-scrolling-content")&&h&&e&&h.contains(e)))return;const u=h.children[h.children.length-1],y=h.scrollHeight-u.offsetTop-u.clientHeight;for(let t of h.children)if(t.contains(e)){const e=h.clientHeight-t.offsetTop+h.scrollTop-t.clientHeight;e<y&&(h.scrollTop=h.scrollTop+(y-e));break}},this._handleKeydown=({key:t,target:e})=>{"Esc"!==t&&"Escape"!==t||this._handleUserInitiatedClose(e)},this.alert=!1,this.ariaLabel="",this.containerClass="",this.fullWidth=!1,this.hasScrollingContent=!1,this.open=!1,this.size=d.MEDIUM,this.preventCloseOnClickOutside=!1,this.preventClose=!1}_handleClickContainer(t){t.target.matches(this.constructor.selectorCloseButton)&&!this.preventClose&&this._handleUserInitiatedClose(t.target)}_handleUserInitiatedClose(t){if(this.open){const e={bubbles:!0,cancelable:!0,composed:!0,detail:{triggeredBy:t}};this.dispatchEvent(new CustomEvent(this.constructor.eventBeforeClose,e))&&(this.open=!1,this.dispatchEvent(new CustomEvent(this.constructor.eventClose,e)))}}_handleSlotChange(){this.querySelector(`${n}-modal-footer`)?this.setAttribute("has-footer",""):this.removeAttribute("has-footer")}firstUpdated(){if(!this.querySelector(this.constructor.selectorModalBody)){const t=document.createElement(this.constructor.selectorModalBody);this.appendChild(t)}}render(){const{alert:t,ariaLabel:s,size:i,hasScrollingContent:l}=this,r=this.containerClass.split(" ").filter(Boolean).reduce(((t,e)=>Object.assign(Object.assign({},t),{[e]:!0})),{}),a=e(Object.assign({[`${n}--modal-container`]:!0,[`${n}--modal-container--${i}`]:i},r));return o`
      <a
        id="start-sentinel"
        class="${n}--visually-hidden"
        href="javascript:void 0"
        role="navigation"></a>
      <div
        aria-label=${s}
        part="dialog"
        class=${a}
        role="${t?"alert":"dialog"}"
        tabindex="-1"
        @click=${this._handleClickContainer}>
        <slot @slotchange="${this._handleSlotChange}"></slot>
        ${l?o` <div class="cds--modal-content--overflow-indicator"></div> `:""}
      </div>
      <a
        id="end-sentinel"
        class="${n}--visually-hidden"
        href="javascript:void 0"
        role="navigation"></a>
    `}async updated(t){if(t.has("open"))if(this.open){this._launcher=this.ownerDocument.activeElement;const t=this.querySelector(this.constructor.selectorPrimaryFocus);await this.constructor._delay(),t?t.focus():f(this.querySelectorAll(this.constructor.selectorTabbable),!0)||this.focus()}else this._launcher&&"function"==typeof this._launcher.focus&&(this._launcher.focus(),this._launcher=null)}static _delay(t=0){return new Promise((e=>{setTimeout(e,t)}))}static get selectorCloseButton(){return`[data-modal-close],${n}-modal-close-button`}static get selectorTabbable(){return r}static get selectorPrimaryFocus(){return`[data-modal-primary-focus],${n}-modal-footer ${n}-button[kind="primary"]`}static get selectorModalBody(){return`${n}-modal-body`}static get eventBeforeClose(){return`${n}-modal-beingclosed`}static get eventClose(){return`${n}-modal-closed`}};y.styles=h,t([l("#start-sentinel")],y.prototype,"_startSentinelNode",void 0),t([l("#end-sentinel")],y.prototype,"_endSentinelNode",void 0),t([a("click")],y.prototype,"_handleClick",void 0),t([a("shadowRoot:focusout")],y.prototype,"_handleBlur",void 0),t([a("document:keydown")],y.prototype,"_handleKeydown",void 0),t([i({type:Boolean,reflect:!0})],y.prototype,"alert",void 0),t([i({attribute:"aria-label"})],y.prototype,"ariaLabel",void 0),t([i({attribute:"container-class"})],y.prototype,"containerClass",void 0),t([i({type:Boolean,reflect:!0,attribute:"full-width"})],y.prototype,"fullWidth",void 0),t([i({type:Boolean,reflect:!0,attribute:"has-scrolling-content"})],y.prototype,"hasScrollingContent",void 0),t([i({type:Boolean,reflect:!0})],y.prototype,"open",void 0),t([i({reflect:!0})],y.prototype,"size",void 0),t([i({type:Boolean,attribute:"prevent-close-on-click-outside"})],y.prototype,"preventCloseOnClickOutside",void 0),t([i({type:Boolean,attribute:"prevent-close"})],y.prototype,"preventClose",void 0),y=t([u(`${n}-modal`)],y);export{d as MODAL_SIZE};
