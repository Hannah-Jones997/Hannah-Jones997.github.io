/**
 * Copyright IBM Corp. 2019, 2020
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
/**
 * @license
 * 
 * This bundle contains the following third-party dependencies:
 * 
 * Also refer to the following links for the license of other third-party dependencies:
 * 
 * https://www.npmjs.com/package/tslib
 * https://www.npmjs.com/package/lit
 * https://www.npmjs.com/package/@lit/context
 * https://www.npmjs.com/package/lodash-es
 * https://www.npmjs.com/package/@floating-ui/dom
 * https://www.npmjs.com/package/flatpickr
 * https://www.npmjs.com/package/lit-html
 * https://www.npmjs.com/package/lit-element
 * https://www.npmjs.com/package/@lit/reactive-element
 * https://www.npmjs.com/package/@floating-ui/core
 * https://www.npmjs.com/package/@floating-ui/utils
 */

import{__decorate as e}from"../../node_modules/tslib/tslib.es6.min.js";import"../../node_modules/@lit/reactive-element/reactive-element.min.js";import{html as t}from"../../node_modules/lit-html/lit-html.min.js";import{LitElement as o}from"../../node_modules/lit-element/lit-element.min.js";import{property as l}from"../../node_modules/@lit/reactive-element/decorators/property.min.js";import{state as s}from"../../node_modules/@lit/reactive-element/decorators/state.min.js";import{prefix as r}from"../../globals/settings.min.js";import{forEach as a}from"../../globals/internal/collection-helpers.min.js";import{TABLE_SORT_DIRECTION as i,TABLE_SIZE as n}from"./defs.min.js";import c from"./data-table.scss.min.js";import{carbonElement as h}from"../../globals/decorators/carbon-element.min.js";import d from"../../globals/decorators/host-listener.min.js";import b from"../../globals/mixins/host-listener.min.js";let u=class extends(b(o)){constructor(){super(...arguments),this.collationFactors={[i.ASCENDING]:1,[i.DESCENDING]:-1},this._searchValue="",this._selectedRows=[],this.batchExpansion=!1,this.expandable=!1,this.filterRows=(e,t)=>e.toLowerCase().indexOf(t.toLowerCase())<0,this.headerCount=0,this.isSelectable=!1,this.isSortable=!1,this.locale="en",this.overflowMenuOnHover=!1,this.radio=!1,this.size=n.LG,this.useStaticWidth=!1,this.useZebraStyles=!1,this.withRowAILabels=!1,this.withRowSlugs=!1,this._handleBatchExpansion=async e=>{const{detail:t,target:o}=e,{expanded:l}=t;o===this._tableHeaderRow&&this._tableRows.forEach((e=>e.expanded=l))},this._handleSort=async e=>{const{detail:t,target:o}=e,{sortDirection:l}=t;if(!this.contains(o))return;const s=[...this._tableHeaderRow.children],r=s.indexOf(o);s.forEach((e=>{(e!==o&&this.isSortable||e.hasAttribute("is-sortable"))&&e.setAttribute("sort-direction","none")})),this._handleSortAction(r,l);const a={bubbles:!0,cancelable:!0,composed:!0,detail:{sortedHeader:s[r]}};this.dispatchEvent(new CustomEvent(this.constructor.eventTableSorted,a)),this._handleFilterRows()},this._handleSearchInput=async e=>{const{detail:t,target:o}=e;if(this.contains(o)){const{value:e}=t;this._searchValue=e,this._handleFilterRows()}},this._handleRowSelect=async e=>{var t,o;const{detail:l,target:s}=e,{selected:a}=l,{_tableBatchActions:i,_tableToolbarContent:n,_tableHeaderRow:c,_selectedRows:h}=this;if(!this.contains(s))return;this.radio?(this._tableRows.forEach((e=>{e!==s&&(e.removeAttribute("selected"),e.shadowRoot.querySelector(`${r}-radio-button`).checked=!1)})),this._selectedRows.push(s)):(h.includes(s)?this._selectedRows=h.filter((e=>e!==s)):h.push(s),i&&(i.active=null===(t=this._selectedRows)||void 0===t?void 0:t.length,i.selectedRowsCount+=a?1:-1),n&&(n.hasBatchActions=this._selectedRows.length));const d=[...this._tableRows].filter((e=>!e.hasAttribute("filtered"))).length,b=null===(o=c.shadowRoot)||void 0===o?void 0:o.querySelector(`${r}-checkbox`).shadowRoot.querySelector(`.${r}--checkbox`),u=this._selectedRows.length===d;b.checked=!!this._selectedRows.length,b.indeterminate=!u&&this._selectedRows.length>0;const p={bubbles:!0,cancelable:!0,composed:!0,detail:{selectedRow:s,selectedRows:h}};this.dispatchEvent(new CustomEvent(this.constructor.eventTableRowSelect,p))},this._handleAllRowsSelect=async e=>{const{detail:t,target:o}=e,{selected:l}=t,{_tableBatchActions:s,_tableToolbarContent:i,_tableRows:n}=this;if(!this.contains(o))return;let c=0;a(n,(e=>{if(!e.filtered){e.selected=l,this.radio&&(e.shadowRoot.querySelector(`${r}-radio-button`).checked=l),this._selectedRows.push(e),c++;const{selectorTableExpandedRows:t}=this.constructor,{nextElementSibling:o}=e;(null==o?void 0:o.matches(t))&&(e.nextElementSibling.selected=l)}})),l||(this._selectedRows=[]),s&&(s.selectedRowsCount=l?c:0,s.active=l),i&&(i.hasBatchActions=l);const h={bubbles:!0,cancelable:!0,composed:!0,detail:{selectedRows:this._selectedRows}};this.dispatchEvent(new CustomEvent(this.constructor.eventTableRowSelectAll,h))},this._handleCancelSelection=async e=>{var t;const{target:o}=e,{_tableHeaderRow:l}=this;this.contains(o)&&(null===(t=l.shadowRoot)||void 0===t||t.querySelector(`${r}-checkbox`).shadowRoot.querySelector(`.${r}--checkbox`).click())}}customSortRow(e,t,o){return"number"==typeof e&&"number"==typeof t?e-t:o.compare(e,t)}_handleSlotChange({target:e}){const t=e.assignedNodes().some((e=>e.nodeType!==Node.TEXT_NODE||e.textContent.trim()));this.withHeader=t}_handleTableBodyChange(){this._tableBody=this.querySelector(this.constructor.selectorTableBody),this._tableExpandedRows=this.querySelectorAll(this.constructor.selectorTableExpandedRows),this._tableRows=this.querySelectorAll(this.constructor.selectorTableRow),this.updateExpandable()}_handleSortAction(e,t){const o=[...this._tableRows];if(o.sort(((o,l)=>{const s=o.querySelectorAll(this.constructor.selectorTableRowCells)[e].textContent,r=l.querySelectorAll(this.constructor.selectorTableRowCells)[e].textContent;return this.collationFactors[t]*this.customSortRow(s,r,this.collator)})),this.expandable){const e=[...this._tableRows],t=[...this._tableExpandedRows],l=e.reduce(((e,o,l)=>(e[o.getAttribute("sort-id")]=t[l],e)),{}),s=[];o.forEach((e=>{const t=e.getAttribute("sort-id");s.push(e),s.push(l[t])})),s.forEach((e=>{this._tableBody.insertBefore(e,null)}))}else o.forEach((e=>{this._tableBody.insertBefore(e,null)}))}_handleFilterRows(){const e=[];a(this._tableRows,(t=>{var o,l;let s=null===(o=t.textContent)||void 0===o?void 0:o.trim(),r=this.filterRows(s,this._searchValue);t.filtered=r,r&&this.expandable&&(s=null===(l=t.nextElementSibling.textContent)||void 0===l?void 0:l.trim(),r=this.filterRows(s,this._searchValue),t.filtered=r),r||e.push(t),this.expandable&&(t.nextElementSibling.filtered=r)}));const t={bubbles:!0,cancelable:!0,composed:!0,detail:{unfilteredRows:e}};this.dispatchEvent(new CustomEvent(this.constructor.eventTableFiltered,t))}_handleDownload({target:e}){const t=[],o=e=>Array.from(e,(e=>e.textContent)),l=this.querySelectorAll(this.constructor.selectorHeaderCell),s=this._selectedRows,r=o(l);s.forEach((e=>{const l={};o(e.querySelectorAll(this.constructor.selectorTableRowCells)).forEach(((e,t)=>{const o=r[t];l[o]=e})),t.push(l)}));const a=new Blob([JSON.stringify(t)],{type:"application/json"});e.href=URL.createObjectURL(a)}connectedCallback(){this.hasAttribute("role")||this.setAttribute("role","table"),this.withRowSlugs&&(this.setAttribute("with-rows-ai-labels",""),this.withRowAILabels=!0),super.connectedCallback()}firstUpdated(){this._tableBatchActions=this.querySelector(this.constructor.selectorTableBatchActions),this._tableToolbar=this.querySelector(this.constructor.selectorTableToolbar),this._tableToolbarContent=this.querySelector(this.constructor.selectorTableToolbarContent),this._tableBody=this.querySelector(this.constructor.selectorTableBody),this._tableHeaderRow=this.querySelector(this.constructor.selectorRowsWithHeader),this._tableExpandedRows=this.querySelectorAll(this.constructor.selectorTableExpandedRows),this._tableRows=this.querySelectorAll(this.constructor.selectorTableRow),this._downloadButton=this.querySelector(this.constructor.selectorToolbarDownload),this._downloadButton&&(this._downloadButton.onclick=this._handleDownload.bind(this)),this.headerCount=this._tableHeaderRow.children.length}updateExpandable(){this._tableRows.forEach(((e,t)=>{e.expandable=this.expandable,e.setAttribute("sort-id",t)})),this._tableHeaderRow.expandable=this.expandable,this._tableHeaderRow.batchExpansion=this.batchExpansion,this.headerCount+=this.expandable?1:-1}updated(e){var t;if(e.has("expandable")&&this.updateExpandable(),e.has("headerCount")&&this._tableExpandedRows.forEach((e=>{e.setAttribute("colspan",this.headerCount)})),e.has("isSelectable")&&(this.isSelectable&&(this._tableHeaderRow.setAttribute("selection-name","header"),this._tableRows.forEach(((e,t)=>{e.hasAttribute("selection-name")||e.setAttribute("selection-name",t)}))),this.headerCount++),e.has("locale")&&(this.collator=new Intl.Collator(this.locale)),e.has("isSortable")&&this.isSortable&&this._enableSortAction(),(e.has("overflowMenuOnHover")||e.has("size"))&&a(this.querySelectorAll(this.constructor.selectorTableCellOverflowMenu),(e=>{const t=e.parentNode,o=t.parentNode;t.overflowMenuOnHover=this.overflowMenuOnHover,o.overflowMenuOnHover=this.overflowMenuOnHover,t.setAttribute("size",this.size),e.setAttribute("size",this.size),e.setAttribute("data-table","")})),e.has("radio")&&a(this.querySelectorAll(this.constructor.selectorTableRow),(e=>{e.radio=this.radio})),e.has("size")&&(a(this.querySelectorAll(this.constructor.selectorAllRows),(e=>{e.setAttribute("size",this.size)})),null===(t=this._tableToolbar)||void 0===t||t.setAttribute("size",this.size)),e.has("useZebraStyles")){this.querySelector(this.constructor.selectorTableBody).useZebraStyles=this.useZebraStyles}this.withRowAILabels?(this._tableHeaderRow.setAttribute("rows-with-ai-label",""),this._tableRows.forEach((e=>{e.setAttribute("rows-with-ai-label","")}))):(this._tableHeaderRow.removeAttribute("rows-with-ai-label"),this._tableRows.forEach((e=>{e.removeAttribute("rows-with-ai-label")})));const o=[];Array.prototype.slice.call(this._tableHeaderRow.children).forEach(((e,t)=>{e.querySelector(`${r}-ai-label`)||e.querySelector(`${r}-slug`)?(e.setAttribute("ai-label",""),o.push(t)):e.removeAttribute("ai-label")})),this._tableRows.forEach((e=>{Array.prototype.slice.call(e.children).forEach(((e,t)=>{o.includes(t)?e.setAttribute("ai-label-in-header",""):e.removeAttribute("ai-label-in-header")}))}))}render(){return t`
      <div class="${r}--data-table-header-container">
        <div ?hidden="${!this.withHeader}" class="${r}--data-table-header">
          <slot @slotchange="${this._handleSlotChange}" name="title"></slot>
          <slot
            @slotchange="${this._handleSlotChange}"
            name="description"></slot>
        </div>
        <slot name="toolbar"></slot>
      </div>

      ${t`<slot
            @cds-table-body-content-change="${this._handleTableBodyChange}"></slot>`}
    `}_enableSortAction(){this.querySelectorAll(this.constructor.selectorHeaderCell).forEach((e=>{e.isSortable=this.isSortable,e.isSelectable=this.isSelectable,e.isExpandable=this.expandable}));const e=[...this._tableHeaderRow.children];let t,o=0;e.forEach(((e,l)=>{e.hasAttribute("sort-direction")&&"none"!==e.getAttribute("sort-direction")&&(t=e.getAttribute("sort-direction"),o=l)})),e.forEach(((e,t)=>{(t!==o&&this.isSortable||e.hasAttribute("is-sortable"))&&e.setAttribute("sort-direction","none")})),this._handleSortAction(o,t)}static get eventBeforeSort(){return`${r}-table-header-cell-sort`}static get eventSearchInput(){return`${r}-search-input`}static get eventBeforeChangeSelectionAll(){return`${r}-table-change-selection-all`}static get eventBeforeChangeSelection(){return`${r}-table-row-change-selection`}static get eventClickCancel(){return`${r}-table-batch-actions-cancel-clicked`}static get eventExpandoToggle(){return`${r}-table-row-expando-toggled`}static get eventTableRowSelect(){return`${r}-table-row-selected`}static get eventTableRowSelectAll(){return`${r}-table-row-all-selected`}static get eventTableSorted(){return`${r}-table-sorted`}static get eventTableFiltered(){return`${r}-table-filtered`}static get selectorTableCellOverflowMenu(){return`${r}-table-cell ${r}-overflow-menu`}static get selectorToolbarDownload(){return`${r}-button[download]`}static get selectorTableBatchActions(){return`${r}-table-batch-actions`}static get selectorTableToolbar(){return`${r}-table-toolbar`}static get selectorTableToolbarContent(){return`${r}-table-toolbar-content`}static get selectorTableToolbarSearch(){return`${r}-table-toolbar-search`}static get selectorTableHead(){return`${r}-table-head`}static get selectorTableBody(){return`${r}-table-body`}static get selectorTableExpandedRows(){return`${r}-table-expanded-row`}static get selectorTableRow(){return`${r}-table-row`}static get selectorTableRowCells(){return`${r}-table-cell`}static get selectorTableCells(){return`${r}-table-cell, ${r}-table-header-cell`}static get selectorHeaderCell(){return`${r}-table-header-cell`}static get selectorRowsWithHeader(){return`${r}-table-header-row,${r}-table-row`}static get selectorAllRows(){return`${r}-table-header-row,${r}-table-row,${r}-table-expanded-row`}};u.styles=c,e([s()],u.prototype,"_downloadButton",void 0),e([s()],u.prototype,"_searchValue",void 0),e([s()],u.prototype,"_tableHeaderRow",void 0),e([s()],u.prototype,"_tableBody",void 0),e([s()],u.prototype,"_tableExpandedRows",void 0),e([s()],u.prototype,"_tableRows",void 0),e([s()],u.prototype,"_tableBatchActions",void 0),e([s()],u.prototype,"_tableToolbar",void 0),e([s()],u.prototype,"_tableToolbarContent",void 0),e([s()],u.prototype,"_selectedRows",void 0),e([l({type:Boolean,reflect:!0,attribute:"batch-expansion"})],u.prototype,"batchExpansion",void 0),e([l({attribute:!1})],u.prototype,"collator",void 0),e([l({type:Boolean,reflect:!0})],u.prototype,"expandable",void 0),e([l()],u.prototype,"filterRows",void 0),e([l()],u.prototype,"headerCount",void 0),e([l({type:Boolean,reflect:!0,attribute:"is-selectable"})],u.prototype,"isSelectable",void 0),e([l({type:Boolean,reflect:!0,attribute:"is-sortable"})],u.prototype,"isSortable",void 0),e([l({reflect:!0})],u.prototype,"locale",void 0),e([l({type:Boolean,reflect:!0,attribute:"overflow-menu-on-hover"})],u.prototype,"overflowMenuOnHover",void 0),e([l({type:Boolean,reflect:!0})],u.prototype,"radio",void 0),e([l({reflect:!0})],u.prototype,"size",void 0),e([l({type:Boolean,attribute:"use-static-width",reflect:!0})],u.prototype,"useStaticWidth",void 0),e([l({type:Boolean,attribute:"use-zebra-styles",reflect:!0})],u.prototype,"useZebraStyles",void 0),e([l({type:Boolean,attribute:"with-header",reflect:!0})],u.prototype,"withHeader",void 0),e([l({type:Boolean,attribute:"with-row-ai-labels"})],u.prototype,"withRowAILabels",void 0),e([l({type:Boolean,attribute:"with-row-slugs"})],u.prototype,"withRowSlugs",void 0),e([d("eventExpandoToggle")],u.prototype,"_handleBatchExpansion",void 0),e([d("eventBeforeSort")],u.prototype,"_handleSort",void 0),e([d("eventSearchInput")],u.prototype,"_handleSearchInput",void 0),e([d("eventBeforeChangeSelection")],u.prototype,"_handleRowSelect",void 0),e([d("eventBeforeChangeSelectionAll")],u.prototype,"_handleAllRowsSelect",void 0),e([d("eventClickCancel")],u.prototype,"_handleCancelSelection",void 0),u=e([h(`${r}-table`)],u);export{n as TABLE_SIZE};
