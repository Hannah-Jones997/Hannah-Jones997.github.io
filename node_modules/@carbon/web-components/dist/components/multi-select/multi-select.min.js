/**
 * Copyright IBM Corp. 2019, 2020
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
/**
 * @license
 * 
 * This bundle contains the following third-party dependencies:
 * 
 * Also refer to the following links for the license of other third-party dependencies:
 * 
 * https://www.npmjs.com/package/tslib
 * https://www.npmjs.com/package/lit
 * https://www.npmjs.com/package/@lit/context
 * https://www.npmjs.com/package/lodash-es
 * https://www.npmjs.com/package/@floating-ui/dom
 * https://www.npmjs.com/package/flatpickr
 * https://www.npmjs.com/package/lit-html
 * https://www.npmjs.com/package/lit-element
 * https://www.npmjs.com/package/@lit/reactive-element
 * https://www.npmjs.com/package/@floating-ui/core
 * https://www.npmjs.com/package/@floating-ui/utils
 */

import{__decorate as e}from"../../node_modules/tslib/tslib.es6.min.js";import"../../node_modules/@lit/reactive-element/reactive-element.min.js";import{html as t}from"../../node_modules/lit-html/lit-html.min.js";import"../../node_modules/lit-element/lit-element.min.js";import{property as l}from"../../node_modules/@lit/reactive-element/decorators/property.min.js";import{query as i}from"../../node_modules/@lit/reactive-element/decorators/query.min.js";import{classMap as s}from"../../node_modules/lit-html/directives/class-map.min.js";import o from"../../packages/icons/lib/close/16.min.js";import{prefix as r}from"../../globals/settings.min.js";import{forEach as c,filter as n,indexOf as a}from"../../globals/internal/collection-helpers.min.js";import d from"../dropdown/dropdown.min.js";import{SELECTION_FEEDBACK_OPTION as u}from"./defs.min.js";import h from"./multi-select.scss.min.js";import{carbonElement as m}from"../../globals/decorators/carbon-element.min.js";import{DROPDOWN_KEYBOARD_ACTION as p,DROPDOWN_TYPE as b}from"../dropdown/defs.min.js";export{DROPDOWN_DIRECTION,DROPDOWN_SIZE}from"../dropdown/defs.min.js";let f=class extends d{constructor(){super(...arguments),this._selectedItemsCount=0,this.clearSelectionLabel="",this.clearSelectionDescription="Total items selected: ",this.clearSelectionText="To clear selection, press Delete or Backspace.",this.locale="en",this.selectAll=!1,this.selectionFeedback=u.TOP_AFTER_REOPEN,this.compareItems=(e,t,{locale:l})=>{e.localeCompare(t,l,{numeric:!0})},this.sortItems=(e,{values:t,compareItems:l,locale:i="en"})=>Array.from(e).sort(((e,s)=>{const o=t.includes(e.value),r=t.includes(s.value);return o&&!r?-1:r&&!o?1:l(e.value,s.value,{locale:i})}))}_selectionShouldChange(e){return Boolean(this.value||e)}_selectionDidChange(e){const t=Array.from(this.querySelectorAll(this.constructor.selectorItem));if((null==e?void 0:e.isSelectAll)&&e.indeterminate)return t.forEach((e=>{e.selected=!1,e.indeterminate=!1})),void(this.value="");e?e.isSelectAll?(t.forEach((t=>{t.isSelectAll||t.disabled||(t.selected=!e.selected),t.indeterminate=!1})),e.selected=!e.selected):e.selected=!e.selected:(c(this.querySelectorAll(this.constructor.selectorItemSelected),(e=>{e.selected=!1})),this._handleUserInitiatedToggle(!1)),this.selectAll&&this._computeSelectAllState(),this.value=n(this.querySelectorAll(this.constructor.selectorItem),(e=>e.selected)).map((e=>e.value)).join(",")}_handleClickInner(e){var t,l,i,s;const o=e.target.closest(`${r}-multi-select-item`);if((null===(t=this._selectionButtonNode)||void 0===t?void 0:t.contains(e.target))&&!this.readOnly)this._handleUserInitiatedSelectItem(),this.filterable?this._filterInputNode.focus():this._triggerNode.focus();else if(o&&!o.hasAttribute("disabled")){this.querySelectorAll(`${r}-multi-select-item`).forEach((e=>e.removeAttribute("highlighted"))),o.setAttribute("highlighted",""),this._handleUserInitiatedSelectItem(o),this.setAttribute("item-clicked",""),this.filterable&&this._filterInputNode.focus()}else(null===(l=this._clearButtonNode)||void 0===l?void 0:l.contains(e.target))?this._handleUserInitiatedClearInput():(null===(i=e.target)||void 0===i?void 0:i.matches(this.constructor.aiLabelItem))||(null===(s=e.target)||void 0===s?void 0:s.matches(this.constructor.slugItem))||(super._handleClickInner(e),this.filterable&&this._filterInputNode.focus())}_handleKeypressInner(e){var t,l;const{key:i}=e,s=this.constructor.getAction(i),{TRIGGERING:o}=p;!(null===(t=this._clearButtonNode)||void 0===t?void 0:t.contains(e.target))||s!==o&&" "!==i?(null===(l=this._selectionButtonNode)||void 0===l?void 0:l.contains(e.target))?(this._handleUserInitiatedSelectItem(),this.open=!0,this.filterable?this._filterInputNode.focus():this._triggerNode.focus()):this.filterable?this._handleKeypressInnerFlterable(e):super._handleKeypressInner(e):this._handleUserInitiatedClearInput()}_handleKeypressInnerFlterable(e){const{key:t}=e,l=this.constructor.getAction(t);if(this.open){if("Enter"===t){const e=this.constructor,t=this.querySelector(e.selectorItemHighlighted);t?this._handleUserInitiatedSelectItem(t):this._handleUserInitiatedToggle(!1)}}else if(l===p.TRIGGERING)this._handleUserInitiatedToggle(!0)}_renderTitleLabel(){const{clearSelectionDescription:e,clearSelectionText:l,disabled:i,hideLabel:o,titleText:c,_selectedItemsCount:n,_slotTitleTextNode:a,_handleSlotchangeLabelText:d}=this,u=s({[`${r}--label`]:!0,[`${r}--label--disabled`]:i,[`${r}--visually-hidden`]:o}),h=c||a&&a.assignedNodes().length>0;return t`
      <label
        part="title-text"
        class="${u}"
        ?hidden="${!h}">
        <slot name="title-text" @slotchange="${d}"
          >${c}</slot
        >
        ${n>0?t`
              <span class="${r}--visually-hidden">
                ${e} ${n},
                ${l}
              </span>
            `:null}
      </label>
    `}_renderPrecedingLabel(){const{disabled:e,readOnly:l,clearSelectionLabel:i,_selectedItemsCount:c}=this,n=s({[`${r}--list-box__selection`]:!0,[`${r}--list-box__selection--multi`]:!0,[`${r}--tag`]:!0,[`${r}--tag--filter`]:!0,[`${r}--tag--high-contrast`]:!0,[`${r}--tag--disabled`]:e});return 0===c?void 0:t`
          <div
            id="selection-button"
            role="button"
            class="${n}"
            tabindex="-1"
            aria-disabled=${l}
            title="${i}">
            ${c}
            ${o({"aria-label":i,class:`${r}--tag__close-icon`})}
          </div>
        `}_renderLabel(){const{label:e,value:l,_selectedItemContent:i}=this,o=s({[`${r}--text-input`]:!0,[`${r}--text-input--empty`]:!l});return this.filterable?t`
          <input
            id="trigger-label"
            class="${o}"
            placeholder="${e}"
            role="combobox"
            aria-controls="menu-body"
            aria-autocomplete="list"
            @input="${this._handleInput}" />
        `:t`
          <span id="trigger-label" class="${r}--list-box__label"
            >${i||e}</span
          >
        `}_renderFollowingLabel(){const{clearSelectionLabel:e,_filterInputNode:l}=this;return l&&l.value.length>0&&this.filterable?t`
          <div
            id="clear-button"
            role="button"
            class="${r}--list-box__selection"
            tabindex="0"
            title="${e}">
            ${o({"aria-label":e})}
          </div>
        `:void 0}_handleInput(){const e=this.querySelectorAll(this.constructor.selectorItem),t=this._filterInputNode.value.toLocaleLowerCase();this.toggleAttribute("has-value",t.length>0),this.open||(this.open=!0),c(e,(e=>{if(e.isSelectAll)return void e.removeAttribute("filtered");e.innerText.toLocaleLowerCase().includes(t)?e.removeAttribute("filtered"):(e.setAttribute("filtered",""),e.removeAttribute("highlighted"))})),this.requestUpdate();const l=this.constructor,i=Array.from(this.querySelectorAll(l.selectorItemResults));if(i.length>0){i.forEach((e=>e.removeAttribute("highlighted"))),this.setAttribute("item-clicked","");const e=i[0];e.setAttribute("highlighted",""),e.focus()}else this._filterInputNode.focus()}_navigate(e){var t;if(this.filterable){const l=this.constructor,i=this.querySelectorAll(l.selectorItemResults),s=this.querySelector(l.selectorItemHighlighted);let o=a(i,s)+e;(null===(t=i[o])||void 0===t?void 0:t.hasAttribute("disabled"))&&(o+=e),o<0&&(o=i.length-1),o>=i.length&&(o=0),c(i,((e,t)=>{e.highlighted=t===o})),this.setAttribute("item-clicked","")}else super._navigate(e),this._triggerNode.classList.add("no-focus-style")}_handleUserInitiatedClearInput(){const e=this.constructor,t=this.querySelectorAll(e.selectorItemFiltered);this._filterInputNode.value="",this.open=!0,this._filterInputNode.focus(),c(t,(e=>{e.removeAttribute("filtered")})),this._filterInputNode.dispatchEvent(new Event("input",{bubbles:!0,composed:!0}))}get _classes(){const{disabled:e,size:t,type:l,invalid:i,readOnly:o,open:c,warn:n,_selectedItemsCount:a}=this,d=l===b.INLINE;return s({[`${r}--multi-select`]:!0,[`${r}--list-box`]:!0,[`${r}--list-box--disabled`]:e,[`${r}--list-box--inline`]:d,[`${r}--list-box--expanded`]:c,[`${r}--list-box--${t}`]:t,[`${r}--multi-select--invalid`]:i,[`${r}--multi-select--warn`]:n,[`${r}--multi-select--inline`]:d,[`${r}--multi-select--readonly`]:o,[`${r}--multi-select--selected`]:a>0,[`${r}--list-box__wrapper--decorator`]:this._hasAILabel,[`${r}--multi-select--selectall`]:this.selectAll})}shouldUpdate(e){const{selectorItem:t,aiLabelItem:l,slugItem:i}=this.constructor,s=this.querySelector(l)||this.querySelector(i),o=this.querySelectorAll(t),{value:r,locale:a}=this,d=r?r.split(","):[];if(e.has("size")&&c(this.querySelectorAll(t),(e=>{e.size=this.size})),e.has("value")&&(c(o,(e=>{e.selected=d.indexOf(e.value)>=0})),this._selectedItemsCount=n(o,(e=>d.indexOf(e.value)>=0&&!e.isSelectAll)).length,this.selectionFeedback===u.TOP)){const e=this.sortItems(o,{values:d,compareItems:this.compareItems,locale:a});s&&e.unshift(s),this.replaceChildren(...e)}if(e.has("open")&&this.selectionFeedback===u.TOP_AFTER_REOPEN){const e=this.sortItems(o,{values:d,compareItems:this.compareItems,locale:a});s&&e.unshift(s),e.forEach((e=>{this.appendChild(e)}))}return!0}updated(e){if(super.updated(e),e.has("open")&&this.open){const e=Array.from(this.querySelectorAll(`${r}-multi-select-item[selected]`));if(e.length>0){let t=null;this.selectAll&&(t=this.querySelector(`${r}-multi-select-item[is-select-all]`)),t||(t=e[0]),this.setAttribute("item-clicked",""),t.focus(),t.setAttribute("highlighted","")}else this.filterable?this._filterInputNode.focus():this._triggerNode.focus()}if(this.selectAll&&e.has("open")&&this.open){const e=Array.from(this.querySelectorAll("cds-multi-select-item")),t=e.find((e=>e.isSelectAll));t&&(this.appendChild(t),e.filter((e=>e!==t)).forEach((e=>this.appendChild(e))))}Array.from(this.querySelectorAll("cds-multi-select-item")).forEach(((e,t)=>{0!==t||e.hasAttribute("is-select-all")?1===t&&this.selectAll?e.setAttribute("flush-top",""):e.removeAttribute("flush-top"):e.setAttribute("flush-top","")})),e.has("open")&&!this.open&&(this._triggerNode.classList.remove("no-focus-style"),this.removeAttribute("item-clicked"))}firstUpdated(e){var t;if(null===(t=super.firstUpdated)||void 0===t||t.call(this,e),!this.selectAll)return;this.shadowRoot.querySelector("slot:not([name])").addEventListener("slotchange",(()=>this._computeSelectAllState()))}_computeSelectAllState(){if(!this.selectAll)return;const e=Array.from(this.querySelectorAll(this.constructor.selectorItem)),t=e.find((e=>e.isSelectAll));if(!t)return;const l=e.filter((e=>!e.isSelectAll&&!e.disabled)),i=l.filter((e=>e.selected)).length,s=i===l.length;t.selected=s,t.indeterminate=i>0&&!s}connectedCallback(){super.connectedCallback(),this.value=n(this.querySelectorAll(this.constructor.selectorItem),(e=>e.selected)).map((e=>e.value)).join(",")}static get selectorMenuBody(){return'div[part="menu-body"]'}static get selectorItemHighlighted(){return`${r}-multi-select-item[highlighted]`}static get selectorItem(){return`${r}-multi-select-item`}static get selectorItemFiltered(){return`${r}-multi-select-item[filtered]`}static get selectorItemResults(){return`${r}-multi-select-item:not([filtered])`}static get selectorItemSelected(){return`${r}-multi-select-item[selected]`}static get eventBeforeToggle(){return`${r}-multi-select-beingtoggled`}static get eventToggle(){return`${r}-multi-select-toggled`}static get eventBeforeSelect(){return`${r}-multi-select-beingselected`}static get eventSelect(){return`${r}-multi-select-selected`}};f.styles=h,e([l({type:Boolean})],f.prototype,"filterable",void 0),e([i("#clear-button")],f.prototype,"_clearButtonNode",void 0),e([i("#selection-button")],f.prototype,"_selectionButtonNode",void 0),e([i("input")],f.prototype,"_filterInputNode",void 0),e([i(`.${r}--list-box__field`)],f.prototype,"_triggerNode",void 0),e([l({attribute:"clear-selection-label"})],f.prototype,"clearSelectionLabel",void 0),e([l({attribute:"clear-selection-description"})],f.prototype,"clearSelectionDescription",void 0),e([l({attribute:"clear-selection-text"})],f.prototype,"clearSelectionText",void 0),e([l()],f.prototype,"locale",void 0),e([l({type:Boolean,reflect:!0,attribute:"select-all"})],f.prototype,"selectAll",void 0),e([l({attribute:"selection-feedback"})],f.prototype,"selectionFeedback",void 0),f=e([m(`${r}-multi-select`)],f);export{b as DROPDOWN_TYPE,u as SELECTION_FEEDBACK_OPTION};
