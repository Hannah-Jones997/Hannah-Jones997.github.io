/**
 * Copyright IBM Corp. 2019, 2020
 *
 * This source code is licensed under the Apache-2.0 license found in the
 * LICENSE file in the root directory of this source tree.
 */
/**
 * @license
 * 
 * This bundle contains the following third-party dependencies:
 * 
 * Also refer to the following links for the license of other third-party dependencies:
 * 
 * https://www.npmjs.com/package/tslib
 * https://www.npmjs.com/package/lit
 * https://www.npmjs.com/package/@lit/context
 * https://www.npmjs.com/package/lodash-es
 * https://www.npmjs.com/package/@floating-ui/dom
 * https://www.npmjs.com/package/flatpickr
 * https://www.npmjs.com/package/lit-html
 * https://www.npmjs.com/package/lit-element
 * https://www.npmjs.com/package/@lit/reactive-element
 * https://www.npmjs.com/package/@floating-ui/core
 * https://www.npmjs.com/package/@floating-ui/utils
 */

import{__decorate as t}from"../../node_modules/tslib/tslib.es6.min.js";import"../../node_modules/@lit/reactive-element/reactive-element.min.js";import{html as e}from"../../node_modules/lit-html/lit-html.min.js";import{LitElement as i}from"../../node_modules/lit-element/lit-element.min.js";import{prefix as o}from"../../globals/settings.min.js";import{property as s}from"../../node_modules/@lit/reactive-element/decorators/property.min.js";import{state as n}from"../../node_modules/@lit/reactive-element/decorators/state.min.js";import l from"./menu.scss.min.js";import{carbonElement as r}from"../../globals/decorators/carbon-element.min.js";import a from"../../globals/decorators/host-listener.min.js";import h from"../../globals/mixins/host-listener.min.js";import{classMap as m}from"../../node_modules/lit-html/directives/class-map.min.js";import{menuDefaultState as c,MenuContext as d}from"./menu-context.min.js";import{provide as p}from"../../node_modules/@lit/context/lib/decorators/provide.min.js";import{consume as u}from"../../node_modules/@lit/context/lib/decorators/consume.min.js";import{MENU_SIZE as v}from"./defs.min.js";let y=class extends(h(i)){constructor(){super(...arguments),this.context=Object.assign(Object.assign({},c),{updateFromChild:t=>{this.context=Object.assign(Object.assign({},this.context),t)}}),this.spacing=8,this.items=[],this.activeitems=[],this.isChild=!1,this.isRtl=!1,this.isRoot=!0,this.direction="ltr",this.open=!0,this.position=[-1,-1],this.size=v.SMALL,this.x=0,this.y=0,this._handleBlur=t=>{const{isRoot:e}=this.context;this.open&&e&&!this.contains(t.relatedTarget)&&this.dispatchCloseEvent(t)},this._handleKeyDown=t=>{const{isRoot:e}=this.context;t.stopPropagation(),"Escape"===t.key||!e&&"ArrowLeft"===t.key?this.dispatchCloseEvent(t):("ArrowUp"!==t.key&&"ArrowDown"!==t.key||t.preventDefault(),this._focusItem(t))},this._focusItem=t=>{var e,i,o;let s;if("CDS-MENU"!==(null===(e=document.activeElement)||void 0===e?void 0:e.tagName)){const t=this._findActiveElementInShadowRoot(document);s=this.activeitems.findIndex((e=>{var i;return t==e.item||(null===(i=e.item.shadowRoot)||void 0===i?void 0:i.activeElement)===t}))}else s=0;let n=s;-1===s?n=0:t&&("ArrowUp"===t.key&&(n-=1),"ArrowDown"===t.key&&(n+=1)),n<0&&(n=this.activeitems.length-1),n>=this.activeitems.length&&(n=0),n!==s&&(null===(o=null===(i=this.activeitems[n])||void 0===i?void 0:i.item)||void 0===o||o.focus())},this._findActiveElementInShadowRoot=t=>{if(null===t)return null;let e=t.activeElement;for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;return e},this._notEmpty=t=>null!=t,this._fitValue=(t,e)=>{const{isRoot:i}=this.context,{width:o,height:s}=this.getBoundingClientRect(),n=i?"vertical":"horizontal",l={x:{max:window.innerWidth,size:o,anchor:"horizontal"===n?t[1]:t[0],reversedAnchor:"horizontal"===n?t[0]:t[1],offset:0},y:{max:window.innerHeight,size:s,anchor:"horizontal"===n?t[0]:t[1],reversedAnchor:"horizontal"===n?t[1]:t[0],offset:i?0:4}};if(this.actionButtonWidth&&this.actionButtonWidth<l.x.size&&("bottom"===this.menuAlignment||"top"===this.menuAlignment)&&(l.x.size=this.actionButtonWidth),this.actionButtonWidth&&("bottom-end"===this.menuAlignment||"top-end"===this.menuAlignment)&&l.x.anchor>=87&&this.actionButtonWidth<l.x.size){const t=l.x.anchor+l.x.reversedAnchor;l.x.anchor=l.x.anchor+t}const{max:r,size:a,anchor:h,reversedAnchor:m,offset:c}=l[e],d=[r-this.spacing-a-h>=0&&h-c,m-a>=0&&m-a+c,r-this.spacing-a],p="top"===this.menuAlignment||"top-end"===this.menuAlignment||"top-start"===this.menuAlignment;"number"==typeof d[0]&&p&&d[0]>=0&&!d[1]&&"y"===e?this.style.transform="translate(0)":p&&!d[0]&&"y"===e&&(d[0]=h-c);const u=d.find((t=>!1!==t));return u>=this.spacing?u:this.spacing},this._getPosition=t=>{if(Array.isArray(t)){const e=t.filter(this._notEmpty);return 2===e.length?e:void 0}return[t,t]},this._calculatePosition=()=>{var t,e;const i={x:this._getPosition(this.x),y:this._getPosition(this.y)};return i.x&&i.y?[null!==(t=this._fitValue(i.x,"x"))&&void 0!==t?t:-1,null!==(e=this._fitValue(i.y,"y"))&&void 0!==e?e:-1]:[-1,-1]},this._handleOpen=async()=>{const t=this._calculatePosition();this.isRtl?(this.style.insetInlineStart="initial",this.style.insetInlineEnd=`${t[0]}px`):(this.style.insetInlineStart=`${t[0]}px`,this.style.insetInlineEnd="initial"),this.style.insetBlockStart=`${t[1]}px`,this.position=t,await this.updateComplete,this._registerMenuItems(),this._setActiveItems();const e={bubbles:!0,cancelable:!0,composed:!0};this.dispatchEvent(new CustomEvent(this.constructor.eventOnOpen,e))&&this.dispatchEvent(new CustomEvent(this.constructor.eventOnOpen,e))},this.dispatchCloseEvent=t=>{const e={bubbles:!0,cancelable:!0,composed:!0,detail:{triggeredBy:t.target}};this.dispatchEvent(new CustomEvent(this.constructor.eventOnClose,e))&&this.dispatchEvent(new CustomEvent(this.constructor.eventOnClose,e))},this._newContextCreate=()=>{this.context=Object.assign(Object.assign({},this.context),{isRoot:!1,size:this.size})},this._registerMenuItems=()=>{var t,e;let i;i=this.isChild?this.querySelector('slot[name="submenu"]').assignedElements():null===(e=null===(t=this.shadowRoot)||void 0===t?void 0:t.querySelector("slot"))||void 0===e?void 0:e.assignedElements(),this.items=null==i?void 0:i.filter((t=>"CDS-MENU-ITEM"===t.tagName?!t.disabled:"CDS-MENU-ITEM-DIVIDER"!==t.tagName))},this._setActiveItems=()=>{var t,e,i;null===(t=this.items)||void 0===t||t.map((t=>{var e,i,s;let n;switch(t.tagName){case"CDS-MENU-ITEM-RADIO-GROUP":{let e=t.querySelectorAll(`${o}-menu-item`);if(null==e?void 0:e.length)for(const i of e.entries())n={item:i[1],parent:t},this.activeitems=[...this.activeitems,n];break}case"CDS-MENU-ITEM-GROUP":{let o=null===(i=null===(e=t.shadowRoot)||void 0===e?void 0:e.querySelector("slot"))||void 0===i?void 0:i.assignedElements();null==o||o.map((t=>{n={item:t,parent:t},this.activeitems=[...this.activeitems,n]}));break}case"CDS-MENU-ITEM-SELECTABLE":n={item:null===(s=t.shadowRoot)||void 0===s?void 0:s.querySelector(`${o}-menu-item`),parent:t},this.activeitems=[...this.activeitems,n];break;default:n={item:t,parent:null},this.activeitems=[...this.activeitems,n]}}));(null!==(i=null===(e=this.activeitems[0])||void 0===e?void 0:e.item)&&void 0!==i?i:document.activeElement).focus()}}static get eventOnClose(){return`${o}-menu-closed`}static get eventOnOpen(){return`${o}-menu-opened`}updated(t){t.has("open")&&this.open&&this._handleOpen()}connectedCallback(){super.connectedCallback(),this.addEventListener("icon-detect",(()=>{var t,e;null===(e=null===(t=this.shadowRoot)||void 0===t?void 0:t.querySelector(".cds--menu"))||void 0===e||e.classList.add(`${o}--menu--with-icons`)}))}async firstUpdated(){this.isRtl="rtl"===this.direction,this.isRoot=this.context.isRoot,this.isChild&&this._newContextCreate(),await this.updateComplete,this._registerMenuItems(),this._setActiveItems()}render(){const{open:t,menuAlignment:i,label:s,position:n,_handleKeyDown:l}=this,r=m({[`${o}--menu`]:!0,[`${o}--menu--${this.size}`]:this.size,[`${o}--menu--box-shadow-top`]:i&&"top"===i.slice(0,3),[`${o}--menu--open`]:t,[`${o}--menu--shown`]:n[0]>=0&&n[1]>=0,[`${o}--menu--with-selectable-items`]:this.context.hasSelectableItems});return e`
      <ul
        class="${r}"
        aria-label="${s}"
        tabindex="-1"
        @keydown="${l}"
        role="menu">
        <slot></slot>
      </ul>
    `}};y.styles=l,t([p({context:d}),u({context:d})],y.prototype,"context",void 0),t([n()],y.prototype,"items",void 0),t([n()],y.prototype,"activeitems",void 0),t([s({type:String})],y.prototype,"label",void 0),t([s({type:Boolean})],y.prototype,"isChild",void 0),t([s()],y.prototype,"actionButtonWidth",void 0),t([s({type:Boolean})],y.prototype,"isRtl",void 0),t([s({type:Boolean})],y.prototype,"isRoot",void 0),t([s({type:String})],y.prototype,"direction",void 0),t([s({type:Boolean,reflect:!0})],y.prototype,"open",void 0),t([s({type:HTMLElement})],y.prototype,"focusreturn",void 0),t([s()],y.prototype,"position",void 0),t([s({attribute:!0})],y.prototype,"size",void 0),t([s()],y.prototype,"mode",void 0),t([s({type:String})],y.prototype,"menuAlignment",void 0),t([s()],y.prototype,"x",void 0),t([s()],y.prototype,"y",void 0),t([a("focusout")],y.prototype,"_handleBlur",void 0),y=t([r(`${o}-menu`)],y);export{v as MENU_SIZE};
